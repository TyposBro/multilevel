<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Click Payment Integration - Spiko</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .payment-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .payment-method {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-method:hover {
            border-color: #007bff;
        }

        .payment-method.selected {
            border-color: #007bff;
            background-color: #f8f9ff;
        }

        .payment-method h3 {
            margin-top: 0;
            color: #333;
        }

        .payment-method p {
            color: #666;
            margin-bottom: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .click-payment-btn {
            background: linear-gradient(#27a8e0 0%, #1c8ed7 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .click-payment-btn:hover {
            background: linear-gradient(#1c8ed7 0%, #1678c2 100%);
        }

        .click-payment-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .click-logo {
            width: 30px;
            height: 25px;
            background: url('https://m.click.uz/static/img/logo.png') no-repeat;
            background-size: contain;
        }

        .status-container {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }

        .status-container.show {
            display: block;
        }

        .error-message {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: #e8f5e8;
            border: 1px solid #c8e6c9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .hidden {
            display: none;
        }

        .plan-selector {
            margin-bottom: 20px;
        }

        .plan-option {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .plan-option:hover {
            border-color: #007bff;
        }

        .plan-option.selected {
            border-color: #007bff;
            background-color: #f8f9ff;
        }

        .plan-option h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .plan-option .price {
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>

<body>
    <div class="payment-container">
        <h1>–°–ø–∏–∫–æ - –ü—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∞</h1>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω –∏ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ Click</p>

        <!-- Plan Selection -->
        <div class="plan-selector">
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω:</h3>
            <div class="plan-option selected" data-plan="silver_monthly">
                <h4>–°–µ—Ä–µ–±—Ä—è–Ω—ã–π –ø–ª–∞–Ω - 1 –º–µ—Å—è—Ü</h4>
                <div class="price">1,000 —Å—É–º</div>
                <p>–î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º –Ω–∞ 30 –¥–Ω–µ–π</p>
            </div>
            <!-- Add more plans as needed -->
        </div>

        <!-- Payment Method Selection -->
        <h3>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</h3>

        <div class="payment-method selected" data-method="web">
            <h3>üåê –í–µ–±-–æ–ø–ª–∞—Ç–∞</h3>
            <p>–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–∞–π—Ç Click –¥–ª—è –æ–ø–ª–∞—Ç—ã –∫–∞—Ä—Ç–æ–π. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç UzCard –∏ Humo.</p>
        </div>

        <div class="payment-method" data-method="invoice">
            <h3>üì± SMS-—Å—á–µ—Ç</h3>
            <p>–ü–æ–ª—É—á–∏—Ç–µ SMS —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –¥–ª—è –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Click.</p>
        </div>

        <!-- Phone Number Input (for invoice method) -->
        <div class="form-group hidden" id="phoneGroup">
            <label for="phoneNumber">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
            <input type="tel" id="phoneNumber" placeholder="+998901234567" maxlength="13">
        </div>

        <!-- Payment Button -->
        <button class="click-payment-btn" id="paymentBtn">
            <span class="click-logo"></span>
            –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Click
        </button>

        <!-- Status Messages -->
        <div class="status-container" id="statusContainer">
            <p id="statusMessage">–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞...</p>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
    </div>

    <!-- Click Checkout Script for embedded payments -->
    <script src="https://my.click.uz/pay/checkout.js"></script>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8787'; // Change to your API URL
        let authToken = 'your_auth_token_here'; // Get this from your authentication system

        // State
        let selectedPlan = 'silver_monthly';
        let selectedMethod = 'web';
        let currentTransactionId = null;
        let statusPollingInterval = null;

        // DOM Elements
        const planOptions = document.querySelectorAll('.plan-option');
        const paymentMethods = document.querySelectorAll('.payment-method');
        const phoneGroup = document.getElementById('phoneGroup');
        const phoneInput = document.getElementById('phoneNumber');
        const paymentBtn = document.getElementById('paymentBtn');
        const statusContainer = document.getElementById('statusContainer');
        const statusMessage = document.getElementById('statusMessage');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');

        // Event Listeners
        planOptions.forEach(option => {
            option.addEventListener('click', () => {
                planOptions.forEach(p => p.classList.remove('selected'));
                option.classList.add('selected');
                selectedPlan = option.dataset.plan;
            });
        });

        paymentMethods.forEach(method => {
            method.addEventListener('click', () => {
                paymentMethods.forEach(m => m.classList.remove('selected'));
                method.classList.add('selected');
                selectedMethod = method.dataset.method;

                if (selectedMethod === 'invoice') {
                    phoneGroup.classList.remove('hidden');
                } else {
                    phoneGroup.classList.add('hidden');
                }
            });
        });

        paymentBtn.addEventListener('click', handlePayment);

        // Functions
        function hideMessages() {
            statusContainer.classList.remove('show');
            errorMessage.classList.remove('show');
            successMessage.classList.remove('show');
        }

        function showStatus(message) {
            hideMessages();
            statusMessage.textContent = message;
            statusContainer.classList.add('show');
        }

        function showError(message) {
            hideMessages();
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
        }

        function showSuccess(message) {
            hideMessages();
            successMessage.textContent = message;
            successMessage.classList.add('show');
        }

        async function handlePayment() {
            if (selectedMethod === 'invoice' && !phoneInput.value) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
                return;
            }

            paymentBtn.disabled = true;
            paymentBtn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞...';

            try {
                const payload = {
                    provider: 'click',
                    planId: selectedPlan
                };

                if (selectedMethod === 'invoice') {
                    payload.paymentMethod = 'invoice';
                    payload.phoneNumber = phoneInput.value;
                }

                const response = await fetch(`${API_BASE}/api/payment/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    currentTransactionId = result.transactionId;

                    if (result.paymentMethod === 'web') {
                        showSuccess('–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã Click...');
                        // Redirect to Click payment page
                        setTimeout(() => {
                            window.location.href = result.paymentUrl;
                        }, 1000);
                    } else if (result.paymentMethod === 'invoice') {
                        showSuccess(result.message);
                        startStatusPolling();
                    }
                } else {
                    showError(result.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
                }
            } catch (error) {
                console.error('Payment error:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            } finally {
                paymentBtn.disabled = false;
                paymentBtn.innerHTML = '<span class="click-logo"></span>–û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Click';
            }
        }

        function startStatusPolling() {
            if (!currentTransactionId) return;

            showStatus('–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã...');

            statusPollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/payment/status/${currentTransactionId}`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    const status = await response.json();

                    if (status.status === 'COMPLETED') {
                        stopStatusPolling();
                        showSuccess('–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.');
                        setTimeout(() => {
                            window.location.reload();
                        }, 3000);
                    } else if (status.status === 'FAILED') {
                        stopStatusPolling();
                        showError('–ü–ª–∞—Ç–µ–∂ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                    } else {
                        // Update status message based on current state
                        let message = '–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã...';
                        if (status.status === 'PREPARED') {
                            message = '–ü–ª–∞—Ç–µ–∂ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω, –æ–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...';
                        }
                        showStatus(message);
                    }
                } catch (error) {
                    console.error('Status check error:', error);
                }
            }, 5000); // Check every 5 seconds

            // Stop polling after 5 minutes
            setTimeout(() => {
                stopStatusPolling();
                showError('–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –≤—Ä—É—á–Ω—É—é.');
            }, 300000);
        }

        function stopStatusPolling() {
            if (statusPollingInterval) {
                clearInterval(statusPollingInterval);
                statusPollingInterval = null;
            }
        }

        // Handle return from Click payment page
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentStatus = urlParams.get('payment_status');
            const transactionId = urlParams.get('transaction_id');

            if (paymentStatus === 'success' && transactionId) {
                currentTransactionId = transactionId;
                startStatusPolling();
            }
        });

        // Alternative: Use Click's embedded payment widget
        function createEmbeddedPayment() {
            // This is an alternative approach using Click's JavaScript SDK
            createPaymentRequest({
                service_id: 80012, // Your Click service ID
                merchant_id: 44439, // Your merchant ID
                amount: 1000.00, // Amount in sums
                transaction_param: "transaction_id_here",
                merchant_user_id: "merchant_user_id_here"
            }, function (data) {
                console.log("Payment completed with status:", data.status);
                if (data.status === 2) { // Status 2 = Success
                    showSuccess('–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
                } else if (data.status < 0) { // Negative status = Error
                    showError('–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã');
                } else {
                    showStatus('–ü–ª–∞—Ç–µ–∂ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ...');
                }
            });
        }
    </script>
</body>

</html>